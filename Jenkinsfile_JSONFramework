pipeline {
    agent { label 'chrome' }
    //tools { maven 'maven' }
    parameters {
            choice(name: 'TestEnvironment', choices: "e2elatest\ne2e", description: 'Defines the environment on which the test will be run')
            choice(name: 'Tags', choices: ['@RDReferralFromJson','@CancerReferralFromJson'], description: 'tags of test to execute')
    }
    
    stages {
        stage('Checkout Source Code') {
            steps {
            // Clean workspace before build
              cleanWs()
                checkout([
                    $class: 'GitSCM', branches: [[name: 'ReferralFromJson']],
                    userRemoteConfigs: [[url: 'https://github.com/genomicsengland/ngis_ui_auto_tests.git', credentialsId:'7f90912e-1e7e-48dd-81b4-3ff5da62ed7d']]
                ])
            }
        }
        stage('UI Referral Creation') {
            steps {
                wrap([$class: 'Xvfb', autoDisplayName: true, displayNameOffset: 0, timeout: 0,screen: '1920x1080x24']) {
                   sh "mvn -f pom.xml -s settings.xml -Dcucumber.options='--tags ${Tags}' clean verify -DTestEnvironment=${TestEnvironment} -ntp"
                }
            }
        }
//        stage('Zip and Archive') {
//            steps {
//                  echo "Archiving build ran at ${BUILD_TIMESTAMP}"
//                  fileOperations([fileZipOperation('target'), fileRenameOperation(destination: 'NGIS_UI_JSON_ReferralCreation_${BUILD_TIMESTAMP}.zip', source: 'target.zip')])
//                  archiveArtifacts "NGIS_UI_JSON_ReferralCreation_${BUILD_TIMESTAMP}.zip"
//
//            }
//        }

        stage('Publish and Archive Results') {
            steps {
                 // archiveArtifacts artifacts:'JsonReferralID.text' , allowEmptyArchive: true
                  archiveArtifacts artifacts:'JsonReferrals.json ' , allowEmptyArchive: true
            }
        }
    }

}
