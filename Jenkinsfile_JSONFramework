pipeline {
    agent { label 'chrome' }
    //tools { maven 'maven' }
    parameters {
            choice(name: 'TestEnvironment', choices: "e2elatest\ne2e\nuat\nbeta", description: 'Defines the environment on which the test will be run')
            choice(name: 'tags', choices: ['@RDReferralFromJson','@CancerReferralFromJson'], description: 'tags of test to execute')
    }
    
    stages {
        stage('Checkout Source Code') {
            steps {
                checkout([
                    $class: 'GitSCM', branches: [[name: 'ReferralFromJson']],
                    userRemoteConfigs: [[url: 'ssh://git@github.com/genomicsengland/ngis_ui_auto_tests.git', credentialsId:'bd67b9d5-5ccb-4aae-9596-a37284f02405']]
                ])
            }
        }
        stage('UI Referral Creation') {
            steps {
                wrap([$class: 'Xvfb', autoDisplayName: true, displayNameOffset: 0, timeout: 0,screen: '1920x1080x24']) {
                   sh "mvn -f pom.xml -Dcucumber.options='--tags ${tags}' clean verify -DTestEnvironment=${TestEnvironment} -ntp"
                }
            }
        }
        stage('Zip and Archive') {
            steps {
                  echo "Archiving build ran at ${BUILD_TIMESTAMP}"
                  fileOperations([fileZipOperation('target'), fileRenameOperation(destination: 'NGIS_UI_JSON_ReferralCreation_${BUILD_TIMESTAMP}.zip', source: 'target.zip')])
                  archiveArtifacts "NGIS_UI_JSON_ReferralCreation_${BUILD_TIMESTAMP}.zip"

            }
        }

        stage('Publish and Archive Results') {
            steps {
                  archiveArtifacts artifacts:'JsonReferralID.text' , allowEmptyArchive: true
                  archiveArtifacts artifacts:'JsonReferrals.json ' , allowEmptyArchive: true
            }
        }
    }

}
